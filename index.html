<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Apple Vision Pro Web</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; color: white; font-family: -apple-system, sans-serif; }
        #stereo-wrapper { display: flex; width: 100vw; height: 100vh; }
        .eye { position: relative; width: 50vw; height: 100vh; overflow: hidden; border-right: 1px solid rgba(255,255,255,0.1); }
        
        canvas.bg-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; display: flex; align-items: center; justify-content: center; }
        
        /* –°–µ—Ç–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π */
        .home-screen { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; pointer-events: auto; }
        .app-btn { width: 80px; height: 80px; background: rgba(255,255,255,0.15); backdrop-filter: blur(15px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 30px; transition: 0.2s; position: relative; }
        .app-btn.highlight { transform: scale(1.2); border-color: #007AFF; box-shadow: 0 0 20px #007AFF; }

        /* –û–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        .window { position: absolute; width: 80%; height: 60%; background: rgba(20,20,20,0.9); backdrop-filter: blur(25px); border-radius: 25px; border: 1px solid rgba(255,255,255,0.2); display: none; flex-direction: column; padding: 15px; pointer-events: auto; }
        .window-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .close-area { width: 30px; height: 30px; background: #ff453a; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }
        .close-area.target { transform: scale(1.3); box-shadow: 0 0 15px #ff453a; }

        /* –ö—É—Ä—Å–æ—Ä */
        .cursor { position: absolute; width: 20px; height: 20px; background: rgba(255,255,255,0.5); border: 2px solid #007AFF; border-radius: 50%; z-index: 100; pointer-events: none; display: none; transform: translate(-50%, -50%); }
        
        #status { position: fixed; top: 10px; left: 10px; z-index: 1000; font-size: 10px; color: #0f0; background: rgba(0,0,0,0.5); padding: 5px; }
        video#raw-video { display: none; }
    </style>
</head>
<body>

<div id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º...</div>
<video id="raw-video" autoplay playsinline></video>

<div id="stereo-wrapper">
    <div class="eye" id="left-eye">
        <canvas class="bg-video" id="can-l"></canvas>
        <div class="ui-layer">
            <div class="home-screen" id="home-l">
                <div class="app-btn" data-id="web">üåê</div>
                <div class="app-btn" data-id="music">üéµ</div>
            </div>
            <div class="window" id="win-l">
                <div class="window-nav"><span>Spatial Browser</span> <div class="close-area">‚úï</div></div>
                <div style="padding: 10px;">–ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω. –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ ‚úï –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è.</div>
            </div>
        </div>
        <div class="cursor" id="cur-l"></div>
    </div>

    <div class="eye" id="right-eye">
        <canvas class="bg-video" id="can-r"></canvas>
        <div class="ui-layer">
            <div class="home-screen" id="home-r">
                <div class="app-btn" data-id="web">üåê</div>
                <div class="app-btn" data-id="music">üéµ</div>
            </div>
            <div class="window" id="win-r">
                <div class="window-nav"><span>Spatial Browser</span> <div class="close-area">‚úï</div></div>
                <div style="padding: 10px;">–ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω. –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ ‚úï –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è.</div>
            </div>
        </div>
        <div class="cursor" id="cur-r"></div>
    </div>
</div>

<script>
    const video = document.getElementById('raw-video');
    const status = document.getElementById('status');
    let activeApp = null;
    let dwellTimer = null;

    // 1. –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã
    async function startCamera() {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(d => d.kind === 'videoinput');
            // –ò—â–µ–º –∫–∞–º–µ—Ä—É —Å–æ —Å–ª–æ–≤–æ–º "back" –∏–ª–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤ —Å–ø–∏—Å–∫–µ (–æ–±—ã—á–Ω–æ —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è)
            const backCam = videoDevices.find(d => d.label.toLowerCase().includes('back')) || videoDevices[videoDevices.length - 1];
            
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { deviceId: backCam ? { exact: backCam.deviceId } : undefined, width: 1280, height: 720 }
            });
            video.srcObject = stream;
            status.innerText = "–ö–∞–º–µ—Ä–∞: OK (Back)";
        } catch (e) {
            status.innerText = "–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + e.message;
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
        }
    }

    // 2. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–∞ –¥–≤–∞ –≥–ª–∞–∑–∞ —á–µ—Ä–µ–∑ Canvas
    const canL = document.getElementById('can-l');
    const canR = document.getElementById('can-r');
    const ctxL = canL.getContext('2d');
    const ctxR = canR.getContext('2d');

    function draw() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canL.width = canR.width = video.videoWidth / 2;
            canL.height = canR.height = video.videoHeight;
            ctxL.drawImage(video, 0, 0, canL.width, canL.height);
            ctxR.drawImage(video, 0, 0, canR.width, canR.height);
        }
        requestAnimationFrame(draw);
    }

    // 3. AI –¢—Ä–µ–∫–∏–Ω–≥ —Ä—É–∫
    const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6 });
    hands.onResults(onResults);

    function onResults(results) {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const point = results.multiHandLandmarks[0][8]; // –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞–ª–µ—Ü
            const x = point.x * window.innerWidth / 2;
            const y = point.y * window.innerHeight;
            updateInteraction(x, y);
        } else {
            document.getElementById('cur-l').style.display = 'none';
            document.getElementById('cur-r').style.display = 'none';
        }
    }

    function updateInteraction(x, y) {
        const cursors = [document.getElementById('cur-l'), document.getElementById('cur-r')];
        cursors.forEach(c => { c.style.display = 'block'; c.style.left = x + 'px'; c.style.top = y + 'px'; });

        // –õ–æ–≥–∏–∫–∞ –∫–ª–∏–∫–∞/–∑–∞–∫—Ä—ã—Ç–∏—è
        const targets = document.querySelectorAll('.app-btn, .close-area');
        let hit = false;

        targets.forEach(t => {
            const r = t.getBoundingClientRect();
            if (x > r.left && x < r.right && y > r.top && y < r.bottom) {
                hit = true;
                t.classList.add('highlight', 'target');
                if (!dwellTimer) {
                    dwellTimer = setTimeout(() => {
                        if (t.classList.contains('close-area')) closeApp();
                        else openApp(t.dataset.id);
                    }, 1200);
                }
            } else {
                t.classList.remove('highlight', 'target');
            }
        });

        if (!hit) { clearTimeout(dwellTimer); dwellTimer = null; }
    }

    function openApp(id) {
        activeApp = id;
        document.querySelectorAll('.home-screen').forEach(h => h.style.display = 'none');
        document.querySelectorAll('.window').forEach(w => w.style.display = 'flex');
        status.innerText = "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ: " + id;
    }

    function closeApp() {
        activeApp = null;
        document.querySelectorAll('.home-screen').forEach(h => h.style.display = 'grid');
        document.querySelectorAll('.window').forEach(w => w.style.display = 'none');
        status.innerText = "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç—ã";
    }

    // –ó–∞–ø—É—Å–∫
    startCamera().then(() => {
        const cam = new Camera(video, { onFrame: async () => { await hands.send({image: video}); } });
        cam.start();
        draw();
    });
</script>
</body>
</html>
