<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vision Pro Web Pro Max</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.15);
            --active: #007AFF;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; overflow: hidden; color: white;
            font-family: -apple-system, sans-serif;
        }

        /* –°—Ç–µ—Ä–µ–æ-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        #stereo-container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }

        .eye-view {
            position: relative;
            width: 50vw;
            height: 100vh;
            overflow: hidden;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        video {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        /* UI –°–ª–æ–π */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(2, 120px);
            gap: 30px;
            pointer-events: auto;
        }

        .icon {
            width: 100px; height: 120px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.3);
            transition: 0.3s;
            text-align: center;
        }

        .icon.selected {
            transform: scale(1.2);
            border-color: var(--active);
            box-shadow: 0 0 30px var(--active);
        }

        /* –û–∫–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π */
        .window {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80%; height: 60%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(30px);
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.4);
            display: none;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
        }

        .window-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .close-btn { background: red; width: 20px; height: 20px; border-radius: 50%; border: none; }

        /* –ö—É—Ä—Å–æ—Ä –ø–∞–ª—å—Ü–∞ */
        .finger-cursor {
            position: absolute;
            width: 25px; height: 25px;
            border: 3px solid white;
            border-radius: 50%;
            background: rgba(0, 122, 255, 0.5);
            z-index: 1000;
            pointer-events: none;
            display: none;
            transition: transform 0.1s linear;
        }

        #debug { position: fixed; top: 5px; left: 5px; z-index: 500; font-size: 12px; color: #0f0; }
    </style>
</head>
<body>

<div id="debug">–ö–∞–º–µ—Ä–∞: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

<div id="stereo-container">
    <div class="eye-view" id="left-eye">
        <video id="vid-l" autoplay playsinline></video>
        <div class="overlay" id="ui-l">
            <div class="app-grid">
                <div class="icon" data-app="safari"><span>üåê</span><br>Safari</div>
                <div class="icon" data-app="music"><span>üéµ</span><br>Music</div>
            </div>
            <div class="window" id="win-safari-l">
                <div class="window-header"><span>üåê Safari</span><button class="close-btn"></button></div>
                <div style="font-size: 14px;">Welcome to Spatial Web.</div>
            </div>
        </div>
        <div class="finger-cursor" id="cursor-l"></div>
    </div>

    <div class="eye-view" id="right-eye">
        <video id="vid-r" autoplay playsinline></video>
        <div class="overlay" id="ui-r">
            <div class="app-grid">
                <div class="icon" data-app="safari"><span>üåê</span><br>Safari</div>
                <div class="icon" data-app="music"><span>üéµ</span><br>Music</div>
            </div>
            <div class="window" id="win-safari-r">
                <div class="window-header"><span>üåê Safari</span><button class="close-btn"></button></div>
                <div style="font-size: 14px;">Welcome to Spatial Web.</div>
            </div>
        </div>
        <div class="finger-cursor" id="cursor-r"></div>
    </div>
</div>

<script>
    const debug = document.getElementById('debug');
    let activeApp = null;
    let hoverTimer = null;

    // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã (Environment = –ó–∞–¥–Ω—è—è)
    async function setupCamera() {
        const constraints = {
            video: { 
                facingMode: { exact: "environment" }, // –§–æ—Ä—Å–∏–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
                width: 640, height: 480 
            }
        };

        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            const vL = document.getElementById('vid-l');
            const vR = document.getElementById('vid-r');
            vL.srcObject = stream;
            // –î–ª—è –≤—Ç–æ—Ä–æ–≥–æ –≤–∏–¥–µ–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö –Ω—É–∂–Ω–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫
            vR.srcObject = stream.clone();
            return vL;
        } catch (e) {
            debug.innerText = "–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + e.message;
            // –ï—Å–ª–∏ –∑–∞–¥–Ω–µ–π –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –ª—é–±—É—é
            const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: true });
            document.getElementById('vid-l').srcObject = fallbackStream;
            document.getElementById('vid-r').srcObject = fallbackStream.clone();
            return document.getElementById('vid-l');
        }
    }

    // 2. –¢—Ä–µ–∫–∏–Ω–≥ —Ä—É–∫
    const hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7 });

    hands.onResults((results) => {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const point = results.multiHandLandmarks[0][8]; // –£–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞–ª–µ—Ü
            // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º X –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –Ω–æ –¥–ª—è –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã –æ–±—ã—á–Ω–æ x = x
            const x = point.x * (window.innerWidth / 2); 
            const y = point.y * window.innerHeight;

            updateUI(x, y);
            debug.innerText = "–†—É–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞";
        } else {
            hideCursors();
            debug.innerText = "–ü–æ–∫–∞–∂–∏—Ç–µ —Ä—É–∫—É";
        }
    });

    function updateUI(x, y) {
        const cL = document.getElementById('cursor-l');
        const cR = document.getElementById('cursor-r');
        [cL, cR].forEach(c => {
            c.style.display = 'block';
            c.style.left = x + 'px';
            c.style.top = y + 'px';
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –∏–∫–æ–Ω–∫–∞–º–∏
        const icons = document.querySelectorAll('.icon');
        let found = false;
        icons.forEach(icon => {
            const rect = icon.getBoundingClientRect();
            // –°–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∞–≤–æ–≥–æ –≥–ª–∞–∑–∞ —É—á–∏—Ç—ã–≤–∞–µ–º –≤–Ω—É—Ç—Ä–∏ CSS –∏–ª–∏ —á–µ—Ä–µ–∑ rect
            if (x > rect.left && x < rect.right && y > rect.top && y < rect.bottom) {
                found = true;
                if (!icon.classList.contains('selected')) {
                    icon.classList.add('selected');
                    startHoverAction(icon.dataset.app);
                }
            } else {
                icon.classList.remove('selected');
            }
        });
        if (!found) cancelHoverAction();
    }

    function startHoverAction(appName) {
        if (hoverTimer) return;
        hoverTimer = setTimeout(() => {
            openApp(appName);
        }, 1500); // 1.5 —Å–µ–∫ –Ω–∞ "–∫–ª–∏–∫"
    }

    function cancelHoverAction() {
        clearTimeout(hoverTimer);
        hoverTimer = null;
    }

    function openApp(name) {
        const wins = [document.getElementById(`win-safari-l`), document.getElementById(`win-safari-r`)];
        wins.forEach(w => w.style.display = 'flex');
        debug.innerText = "–û—Ç–∫—Ä—ã—Ç–æ: " + name;
    }

    function hideCursors() {
        document.getElementById('cursor-l').style.display = 'none';
        document.getElementById('cursor-r').style.display = 'none';
        cancelHoverAction();
    }

    // –ó–∞–ø—É—Å–∫
    setupCamera().then(video => {
        const camera = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 640, height: 480
        });
        camera.start();
    });

</script>
</body>
</html>
